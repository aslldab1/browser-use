# 🧠 Browser-Use 源码阅读指南

## 📋 目录
1. [项目概览](#项目概览)
2. [架构设计](#架构设计)
3. [核心模块](#核心模块)
4. [阅读路径](#阅读路径)
5. [关键概念](#关键概念)
6. [调试技巧](#调试技巧)
7. [扩展开发](#扩展开发)

---

## 🎯 项目概览

### 项目定位
Browser-Use 是一个让 AI 代理能够控制浏览器的 Python 库，核心目标是：
- **自动化浏览器操作** - 通过 AI 代理执行复杂的网页任务
- **智能交互** - 基于 LLM 推理进行页面导航和操作
- **可扩展架构** - 支持多种 LLM 提供商和自定义功能

### 技术栈
- **Python 3.11+** - 核心语言
- **Playwright** - 浏览器自动化引擎
- **Pydantic v2** - 数据验证和序列化
- **异步编程** - 基于 asyncio 的高性能架构
- **多种 LLM 支持** - OpenAI、Anthropic、Google、Groq 等

---

## 🏗️ 架构设计

### 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   User Input    │    │   Agent Loop    │    │   Browser       │
│   (Task/LLM)    │───▶│   (Decision)    │───▶│   (Playwright)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Controller    │    │   DOM Service   │
                       │   (Actions)     │◀───│   (Extraction)  │
                       └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   File System   │
                       │   (Persistence) │
                       └─────────────────┘
```

### 核心组件关系
1. **Agent Service** - 决策中心，协调所有组件
2. **Browser Service** - 浏览器控制，基于 Playwright
3. **Controller Service** - 动作执行器
4. **DOM Service** - 页面内容提取和分析
5. **LLM Service** - 大语言模型集成
6. **File System** - 数据持久化

---

## 🔧 核心模块

### 1. Agent 模块 (`browser_use/agent/`)
**核心文件：**
- `service.py` (1682行) - Agent 主服务，包含执行循环
- `prompts.py` (314行) - 系统提示词管理
- `views.py` (514行) - 数据模型和视图
- `system_prompt.md` (171行) - 核心系统提示词

**关键类：**
```python
class Agent:
    """主要的 Agent 类，负责协调整个执行流程"""
    
class SystemPrompt:
    """系统提示词管理，支持动态提示词"""
    
class AgentHistoryList:
    """代理历史记录管理"""
```

### 2. Browser 模块 (`browser_use/browser/`)
**核心文件：**
- `service.py` - 浏览器服务实现
- `session.py` - 浏览器会话管理
- `profile.py` - 浏览器配置管理

**关键类：**
```python
class BrowserSession:
    """浏览器会话，管理单个浏览器实例"""
    
class BrowserProfile:
    """浏览器配置，包含启动参数等"""
    
class Browser:
    """浏览器抽象层"""
```

### 3. Controller 模块 (`browser_use/controller/`)
**核心文件：**
- `service.py` - 控制器服务
- `registry.py` - 动作注册表

**关键类：**
```python
class Controller:
    """动作控制器，执行具体的浏览器操作"""
    
class ActionResult:
    """动作执行结果"""
```

### 4. DOM 模块 (`browser_use/dom/`)
**核心文件：**
- `service.py` - DOM 服务
- `extractor.py` - 内容提取器

**关键类：**
```python
class DomService:
    """DOM 服务，负责页面内容提取和分析"""
```

### 5. LLM 模块 (`browser_use/llm/`)
**支持的提供商：**
- `openai/` - OpenAI 集成
- `anthropic/` - Anthropic 集成
- `google/` - Google 集成
- `groq/` - Groq 集成
- `ollama/` - Ollama 集成

---

## 📚 阅读路径

### 🚀 快速入门路径（推荐新手）
1. **入口点** - `browser_use/__init__.py`
2. **基础使用** - `examples/` 目录下的示例
3. **核心概念** - `browser_use/agent/system_prompt.md`
4. **主要流程** - `browser_use/agent/service.py` 的 `run()` 方法

### 🔍 深度理解路径（推荐进阶）
1. **架构概览** - `README.md` 和 `pyproject.toml`
2. **数据模型** - `browser_use/agent/views.py`
3. **执行引擎** - `browser_use/agent/service.py`
4. **浏览器控制** - `browser_use/browser/`
5. **动作系统** - `browser_use/controller/`
6. **DOM 处理** - `browser_use/dom/`

### 🛠️ 开发调试路径
1. **CLI 工具** - `browser_use/cli.py`
2. **配置管理** - `browser_use/config.py`
3. **日志系统** - `browser_use/logging_config.py`
4. **测试用例** - `tests/` 目录

---

## 🎯 关键概念

### 1. Agent 执行循环
```python
# 核心执行流程
async def run(self) -> AgentHistoryList:
    """Agent 主执行循环"""
    while not self._should_stop():
        # 1. 获取当前状态
        browser_state = await self._get_browser_state()
        
        # 2. 构建 LLM 输入
        messages = self._build_messages(browser_state)
        
        # 3. 调用 LLM 获取决策
        response = await self.llm.ainvoke(messages)
        
        # 4. 解析并执行动作
        actions = self._parse_actions(response)
        await self._execute_actions(actions)
        
        # 5. 更新历史
        self._update_history(actions)
```

### 2. 动作系统
```python
# 动作注册和执行
@controller.registry.action("点击元素")
async def click_element(index: int, page: Page):
    """点击指定索引的元素"""
    # 实现逻辑
    return ActionResult(success=True)

# 动作调用
actions = [
    {"click_element": {"index": 5}},
    {"scroll": {"down": True}},
    {"extract_structured_data": {"query": "获取所有链接"}}
]
```

### 3. 状态管理
```python
# 浏览器状态
class BrowserState:
    url: str
    interactive_elements: List[InteractiveElement]
    page_content: str
    screenshot: Optional[bytes]

# 代理状态
class AgentState:
    user_request: str
    file_system: FileSystemState
    todo_contents: str
    step_info: StepInfo
```

### 4. 提示词系统
- **系统提示词** - 定义 Agent 的行为和能力
- **动态提示词** - 根据任务类型调整
- **上下文管理** - 历史记录和当前状态

---

## 🐛 调试技巧

### 1. 启用详细日志
```python
import logging
logging.basicConfig(level=logging.DEBUG)

# 或者使用环境变量
os.environ['BROWSER_USE_LOGGING_LEVEL'] = 'debug'
```

### 2. 使用 CLI 调试
```bash
# 安装 CLI 版本
pip install "browser-use[cli]"

# 启动交互式调试
browser-use
```

### 3. 查看执行历史
```python
# 保存对话记录
agent = Agent(
    task="...",
    save_conversation_path="./conversations"
)

# 查看生成的对话文件
# conversations/conversation_*.txt
```

### 4. 浏览器调试
```python
# 启用浏览器调试
browser_session = BrowserSession(
    browser_profile=BrowserProfile(
        headless=False,  # 显示浏览器
        slow_mo=1000     # 减慢操作速度
    )
)
```

---

## 🔧 扩展开发

### 1. 添加自定义动作
```python
from browser_use.controller import Controller

controller = Controller()

@controller.registry.action("自定义操作")
async def custom_action(param: str, page: Page):
    """自定义动作实现"""
    # 你的逻辑
    return ActionResult(success=True, extracted_content="结果")
```

### 2. 集成新的 LLM 提供商
```python
# 在 browser_use/llm/ 下创建新目录
# 实现 ChatProvider 接口
class ChatCustomProvider(ChatProvider):
    async def ainvoke(self, messages, **kwargs):
        # 实现调用逻辑
        pass
```

### 3. 自定义浏览器配置
```python
# 扩展浏览器配置
class CustomBrowserProfile(BrowserProfile):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        # 添加自定义配置
```

---

## 📖 推荐阅读顺序

### 第一周：基础理解
1. **Day 1-2**: 阅读 README 和示例代码
2. **Day 3-4**: 理解 Agent 基本流程
3. **Day 5-7**: 运行示例并调试

### 第二周：深入核心
1. **Day 8-10**: 研究 Agent Service 实现
2. **Day 11-12**: 理解动作系统
3. **Day 13-14**: 学习 DOM 处理

### 第三周：高级特性
1. **Day 15-17**: 研究 LLM 集成
2. **Day 18-19**: 理解文件系统
3. **Day 20-21**: 学习扩展开发

---

## 🎯 重点文件清单

### 核心文件（必读）
- `browser_use/agent/service.py` - Agent 主服务
- `browser_use/agent/system_prompt.md` - 系统提示词
- `browser_use/agent/views.py` - 数据模型
- `browser_use/browser/service.py` - 浏览器服务
- `browser_use/controller/service.py` - 控制器服务

### 重要文件（推荐）
- `browser_use/dom/service.py` - DOM 服务
- `browser_use/llm/openai/chat.py` - OpenAI 集成
- `browser_use/cli.py` - CLI 实现
- `examples/` - 示例代码

### 参考文件（可选）
- `tests/` - 测试用例
- `docs/` - 文档
- `pyproject.toml` - 项目配置

---

## 💡 学习建议

1. **从示例开始** - 先运行和理解示例代码
2. **逐步深入** - 按照推荐路径逐步学习
3. **动手实践** - 修改示例代码进行实验
4. **查看日志** - 启用详细日志理解执行流程
5. **参与社区** - 加入 Discord 获取帮助

---

## 🔗 相关资源

- **官方文档**: https://docs.browser-use.com
- **GitHub**: https://github.com/browser-use/browser-use
- **Discord**: https://link.browser-use.com/discord
- **云端版本**: https://cloud.browser-use.com

---

*这个指南将帮助你系统性地理解 Browser-Use 的源码。建议按照推荐路径逐步学习，并在实践中加深理解。* 